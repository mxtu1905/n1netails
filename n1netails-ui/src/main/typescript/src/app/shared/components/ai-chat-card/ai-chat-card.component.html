<nz-card nzTitle="AI Chat & Notes" class="ai-chat-card dark-theme-chat">
  <nz-spin [nzSpinning]="isLoadingNotes">
    <div class="chat-history-container" #chatHistoryContainer>
      <nz-list [nzDataSource]="notes" nzItemLayout="horizontal">
        <ng-template #item let-item>
          <nz-comment [nzAuthor]="item.username" [nzDatetime]="item.timestamp | date:'short'">
            <nz-avatar
              nz-comment-avatar
              [nzText]="item.isHuman ? item.username.substring(0, 1).toUpperCase() : 'AI'"
              [ngStyle]="{'background-color': item.isHuman ? '#1890ff' : '#bfbfbf'}"
            ></nz-avatar>
            <nz-comment-content>
              <div *ngIf="item.isLoading; else messageContent" class="loading-message-placeholder">
                <nz-spin nzSimple [nzSize]="'small'"></nz-spin> Loading response...
              </div>
              <ng-template #messageContent>
                <markdown [data]="item.noteText" class="chat-message-content"></markdown>
                <div *ngIf="!item.isHuman && item.llmProvider" class="ai-meta">
                  Provider: {{ item.llmProvider }} | Model: {{ item.llmModel }}
                </div>
              </ng-template>
            </nz-comment-content>
          </nz-comment>
        </ng-template>
        <nz-list-empty *ngIf="!notes || notes.length === 0"></nz-list-empty>
      </nz-list>
    </div>
  </nz-spin>

  <div class="chat-input-area">
    <nz-form-item>
      <nz-textarea-count [nzMaxCharacterCount]="2000">
        <textarea
          nz-input
          rows="3"
          [(ngModel)]="newNoteText"
          placeholder="Type your note or prompt for the AI..."
          (keydown.enter)="sendToLlm()"
          [disabled]="isSendingMessage"
        ></textarea>
      </nz-textarea-count>
    </nz-form-item>
    <nz-form-item class="action-buttons">
      <button
        nz-button
        nzType="default"
        (click)="addNote()"
        [nzLoading]="isSendingMessage && newNoteText !== ''"
        [disabled]="!newNoteText.trim() || isSendingMessage"
      >
        Add Note
      </button>
      <button
        nz-button
        nzType="primary"
        (click)="sendToLlm()"
        [nzLoading]="isSendingMessage && newNoteText !== ''"
        [disabled]="!newNoteText.trim() || isSendingMessage"
        style="margin-left: 8px;"
      >
        Send to LLM
      </button>
    </nz-form-item>
  </div>
</nz-card>
